Starting the Device Simulator and NSO
=====================================

This example shows how to operate NSO towards the example network. The network
is generated by ncs-netsim, emulating a network consisting of three simulated
devices defined by the NSO package in `./packages/router`.

See the `Further Reading` section below with pointers to the NSO documentation
for details on NSO packages and netsim.

Starting the Simulated Network
------------------------------

The simulated network for this example:

                     -------
                     | NSO |
                     -------
                        |
                        |
    ----------------------------------------------------------
         |                      |                      |
         |                      |                      |
      -------                -------                -------
      | ex0 |                | ex1 |                | ex2 |
      -------                -------                -------

To run the steps below in this README from a demo shell script:

    make demo

Stop the demo:

    ncs-netsim stop
    ncs --stop
    make clean

The below steps are similar to the demo script using the J-style CLI instead of
the C-style CLI and SSH user/password authentication instead of SSH public key
authentication.

To start the simulated devices, we need to build them using `make`:

    make all

This builds the packages and creates a simulated network consisting of the
three simulated routers called `ex0`, `ex1`, and `ex2`. The simulated network
environment resides in the newly generated directory `./netsim`, created by the
`ncs-netsim create-network` command in the `Makefile`.

To start the simulated network, use the `ncs-netsim start` command:

    ncs-netsim start
    DEVICE ex0 OK STARTED
    DEVICE ex1 OK STARTED
    DEVICE ex2 OK STARTED

At this point, we have three running simulated routers that NSO can communicate
with over NETCONF. Each router runs a ConfD instance with a NETCONF agent on
localhost and the YANG data models describe what the device can do under
`./packages/router/src/yang`.

You can list the devices in the simulated network using `ncs-netsim list`:

    ncs-netsim list
    name=ex0 netconf=12022 ipc=5000 dir=/home/.../netsim/ex/ex0
    name=ex1 netconf=12023 ipc=5001 dir=/home/.../netsim/ex/ex1
    name=ex2 netconf=12024 ipc=5002 dir=/home/.../netsim/ex/ex2

You will find additional `ncs-netsim` commands by issuing:

    ncs-netsim help

Starting NSO
------------

To start the NSO server with the default configuration, run the following:

    ncs

NSO will now load the data models, packages, and initialization data. NSO will
only connect to real or simulated devices once an operator tells it.  NSO is
now ready for operators to log in.

To connect to the NSO Command Line Interface (CLI), run:

    ncs_cli -u admin

The flag `-u admin` makes you log in as the `admin` user. This NSO example is
configured for the `admin` user, so if you omit the flag, you will get problems
due to lacking authorization.

When you start the CLI this way, no password is required. The `ncs_cli` program
is intended to run as a login program, so the system will require a password
before allowing the `ncs_cli` program to run. Anyone who can get a terminal
window shell prompt can in log in to NSO as any NSO user.

To login to the NSO CLI like an external user, such that a password is
required, you can, for example, use the `ssh` command:

    ssh admin@localhost -p 2024

The default password for the admin user in this example is `admin`.

To login on the NSO Web User Interface (WebUI), direct your browser to

    http://localhost:8080

And login as user `admin` with password `admin`.

    It is often interesting to examine what NSO sends to the devices. To get a
    trace output of what NSO sends to the devices, run the following command in
    NSO:

    > configure
    % set devices global-settings trace pretty
    % commit

Managing Devices Using NSO
--------------------------

NSO will only manage the devices it is configured to manage. You can view the
list of devices NSO manages using the following command:

    > show configuration devices device | display-level 2
    device ex0 {
        address   127.0.0.1;
        port      12022;
        authgroup default;
    }
    device ex1 {
            address   127.0.0.1;
            port      12023;
            authgroup default;
    }
    device ex2 {
        address   127.0.0.1;
        port      12024;
        authgroup default;
    }

The `display-level 2` directive ensures we get only the device names and basic
configuration (2 levels). By omitting the `display-level`, NSO will show all
device configuration data.

Add or remove entries in the device list to change which devices NSO will
manage, how NSO connects to them, etc. In this example, the list of devices
to manage was built as CDB database initialization data by the earlier
`make all` command.

The NSO Device Manager
----------------------

Once logged in to the NSO CLI, you can show the device status or change the
device configuration. At this point, NSO is unaware of whether the devices
exist or their configurations. So the first step will be to connect to the
devices and read their configurations into the NSO database:

    > request devices connect
    > request devices sync-from

View the configuration of the `ex0` device using the command:

    > show configuration devices device ex0 config

Or show a particular piece of configuration from several devices:

    > show configuration devices device ex0..2 config r:sys routes inet

Change a particular piece of configuration across multiple devices with the
command:

    > configure
    % set devices device ex0..2 config r:sys routes inet route 10.2.0.0 24 \
      next-hop 10.2.0.254 metric 20
    % commit
    % exit

Show the routes again to see the result

    > show configuration devices device ex0..2 config r:sys routes inet

What if a Device is Down?
-------------------------

To see how NSO behaves if a device is or goes down, log out of the NSO CLI or
use a separate terminal window to get to a terminal window prompt. There, you
can shut down one of the simulated devices with the command:

    ncs-netsim stop ex1

You can check which simulated devices are up and down with the command:

    $ ncs-netsim is-alive
    DEVICE ex0 OK
    DEVICE ex1 FAIL
    DEVICE ex2 OK

Back to the NSO CLI, e.g.

    ncs_cli -u admin

Make another device configuration change:

    > configure
    % set devices device ex0 config r:sys ntp key 3
    % commit

    % set devices device ex0..2 config r:sys ntp key 3
    % commit

The first commit will work fine here since it does not involve the device
`ex1`, which is down. The second commit is aborted since it contains a change
affecting a device that refused it. Note that the configuration of all devices
remains unchanged in this case. The new configuration has never been live on
any of them, so there is no disturbance to the network.

The transaction with the changes still exists in the `admin` user NSO session,
however, so we can choose several paths forward from here:
- Forget about the change entirely with:

      % revert

  or:

      % exit

- Or remove the change on `ex1` with:

      % delete devices device ex1 config r:sys ntp key 3

- Or commit the change through the commit queue with:

      % commit commit-queue async

- Or bring up `ex1` and try committing again from a terminal window with:

      ncs-netsim start ex1

  Then in the NSO CLI:

      % commit

Here, let's try the commit-queue alternative:

    % commit commit-queue async
    % exit

The configuration change will be stored on all devices that respond correctly,
but will remain in the queue until the item is delivered on all, thus achieving
eventual consistency.

You can view the commit queue using the command:

    > show devices commit-queue

Exit the NSO CLI or run the `ncs-netsim` command in a separate terminal window:

    ncs-netsim start ex1

And connect to the NSO CLI again:

    ncs_cli -u admin

You can monitor the commit queue from, for example, the CLI

    > show devices commit-queue

Syncing
-------

One of the first actions we did when we started NSO above was to sync NSO with
all the managed devices to get an up-to-date view of all devices'
configurations in NSO. After this point, most NSO users would consider NSO to
hold the primary configuration and synchronize mostly from NSO to the
devices. This can be done (efficiently) for all devices in the network or
individually per device. It is also possible to check whether some or all
devices are in sync with NSO without affecting their configuration.

To verify that all devices are in sync with NSO:

    > request devices check-sync

To introduce a configuration mismatch, exit the NSO CLI or open a
separate terminal window, and open a Cisco IOS-style CLI directly to the
simulated device:

    > exit
    $ ncs-netsim cli-i ex1
    > enable
    > configure terminal
    # no sys routes
    # exit
    # exit

Log in to the NSO CLI again:

    ncs_cli -u admin

Ask NSO to check if the devices are in sync:

    > request devices check-sync
    sync-result {
        device ex0
        result in-sync
    }
    sync-result {
        device ex1
        result out-of-sync
    }
    sync-result {
        device ex2
        result in-sync
    }

To see the full details of what is out-of-sync:

    > request devices device ex1 compare-config

Lines beginning with a minus sign (-) are missing on the device, and lines
starting with a plus sign (+) have been added to the device.

We can now choose to copy and paste from the diff or sync the device config.
- From the device to NSO with:

      > request devices device ex1 sync-from

- To the device from NSO:

      > request devices device ex1 sync-to dry-run

Here, let's confirm the sync to the device:

    > request devices device ex1 sync-to
    > exit

Restarting the Device Simulator
-------------------------------

Sometimes, getting the simulated devices back into a well-defined initial,
clean state is helpful. This can be done with the ncs-netsim reset and restart
commands.

The `ncs-netsim restart` command will:
- stop the network
- remove all CDB database files in the device simulator instances
- restart the network

      $ ncs-netsim restart
      DEVICE ex0 STOPPED
      DEVICE ex1 STOPPED
      DEVICE ex2 STOPPED
      DEVICE ex0 RESET
      DEVICE ex1 RESET
      DEVICE ex2 RESET
      DEVICE ex0 OK STARTED
      DEVICE ex1 OK STARTED
      DEVICE ex2 OK STARTED

The `ncs-netsim reset` command will only remove the database files for the
simulated devices and not start or stop anything.

Controlling NSO
---------------

When NSO starts, NSO consults a configuration file for directories to scan for
schema, FXS, files compiled from YANG models, where to store log files,
management interfaces to enable, and many other things. Unless an NSO
configuration file is specified on the command line when NSO is started, NSO
will use `$NCS_DIR/etc/ncs/ncs.conf` file.

By default, NSO is started as a daemon but can also be started in foreground
mode. With the `-c` flag to specify an NSO config file, NSO might be started
like this:

    ncs --verbose --foreground -c ./ncs.conf

Once NSO is running, it may be helpful to see some status information. This can
be displayed from a terminal window prompt:

    ncs --status

or in the NSO CLI

    > show ncs-state

If you encounter a problem with strange NSO behavior, producing a "debug dump"
to enclose the trouble report may be helpful. If the problem can be repeated,
it is often beneficial to take a debug dump just before triggering the issue
and one just after. Debug dumps are produced with the following command at a
terminal window prompt:

    ncs --debug-dump filename

Many more NSO commands are documented by the nso(1) man page. You can
have them listed with the command

    ncs --help

Finally, to stop NSO, run

    ncs --stop

This will shut down NSO properly. All configuration data in the database is
preserved when NSO is started the next time. If you would like to clear the NSO
database and restart from scratch, and you are using the default database and
log locations in `ncs.conf`, then do this before starting NSO again:

    ncs-setup --reset

To clear NSO and the network from all data and restart from scratch:

    ncs-netsim restart
    ncs-setup --reset
    ncs

Behind the Scenes
-----------------

In this example, we use a single package, the Network Element Driver (NED) for
the three simulated routers, in `../packages/router`. This package also
contains netsim code. The `netsim` target in the `Makefile` is used to create
the simulated network. This example's `ncs-setup` command created a
`netsim` directory, which holds the required files.

Since the package must be built before being used, the `all` (default)
`Makefile` target starts the package build process and then creates the
simulated network using the `ncs-netsim create-network` command. Starting the
netsim devices is left to the user.

The example uses an XML init file to avoid manually adding the devices to NSO.
This XML file is loaded when NSO is started with an empty CDB database to
pre-populate an (otherwise empty) CDB. The default `ncs.conf` file has an entry
similar to the following:

```xml
  <!-- Where the database (and init XML) files are kept -->
  <cdb>
    <db-dir>./ncs-cdb</db-dir>
    <!-- Always bring in the good system defaults -->
    <init-path>
      <dir>${NCS_DIR}/var/ncs/cdb</dir>
    </init-path>
  </cdb>
```

In addition to the `init-path` location, NSO will look for the XML init files
in the `db-dir`. So, there is a `./ncs-cdb/ncs_init.xml` file, which defines
the connection information for the three simulated devices. It is loaded when
NSO starts up the first time (when there are no existing database files),
and the device's initial configuration is loaded automatically.

Something similar happens with packages, which are also loaded automatically at
the first start without reloading the package. A user can then start NSO with
the `ncs` command.

Cleanup
-------

Stop all daemons and clean all created files:

    ncs-netsim stop
    ncs --stop
    make clean

Further Reading
---------------

+ The demo.sh shell script
+ NSO Operation and Usage guide chapter
    - Basic Operations
    - Network Simulator
    - NSO Device Manager
+ NSO Administration guide chapter "Package Management"
+ NSO Development guide chapters "Packages" and "Developing Packages"
+ ncs-make-package(1) man page
+ ncs-netsim(1) man page
+ ncs-setup(1) man page
+ nso(1) man page